SELECT 
    PC.PRO_CUR_CODE,
    PC.INV_AMT_FC AS INV_AMT_FC,
    CLD.C_UNIT,
    CLD.D_UNIT,
    LOAN_YN,
    CONTROL_YN,
    PC.PROVIER_IDN,
    CUS_NAME AS PROVIER_NAME,
    PC.PRO_NAME,
    PC.BANK_PRO_CODE,
    PC.REF_NO,
    CASE 
        WHEN PR.LOAN_PLATFORM_CODE IN ('OTH', 'SEC') 
        THEN PC.BANK_PRO_CODE 
        ELSE PC.REF_NO 
    END AS SHOW_REF_NO,
    PC.TRAN_CUR_CODE,
    TRAN_DATE,
    PRICE_DATE,
    BUY_PRICE,
    PC.PRICE,
    PC.INV_AMT_FC - COALESCE(
        CASE 
            WHEN NULLIF(CLD.D_UNIT, 0) IS NULL 
            THEN CLD.C_UNIT 
            ELSE CLD.INV_AMT_FC 
        END, 0
    ) AS INV_AMT_FC,
    ORDER_L_INT,
    PC.UNIT - CASE 
        WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT 
        ELSE 0 
    END AS UNIT,
    EXPIRE_DATE,
    TOT_DIVIDEND_FC,
    PC.PRICE * (PC.UNIT - COALESCE(
        CASE 
            WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT 
            ELSE 0 
        END, 0)) 
        - PC.INV_AMT_FC 
        - COALESCE(
            CASE 
                WHEN NULLIF(CLD.D_UNIT, 0) IS NULL 
                THEN CLD.C_UNIT 
                ELSE CLD.INV_AMT_FC 
            END, 0
        ) + PC.TOT_DIVIDEND_FC AS UPL_FC_DIVIDEND,
    (
        PC.PRICE * (PC.UNIT - COALESCE(
            CASE 
                WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT 
                ELSE 0 
            END, 0)) 
        - PC.INV_AMT_FC 
        - COALESCE(
            CASE 
                WHEN NULLIF(CLD.D_UNIT, 0) IS NULL 
                THEN CLD.C_UNIT 
                ELSE CLD.INV_AMT_FC 
            END, 0
        ) + PC.TOT_DIVIDEND_FC
    ) / NULLIF(
        COALESCE(
            PC.INV_AMT_FC - COALESCE(
                CASE 
                    WHEN NULLIF(CLD.D_UNIT, 0) IS NULL 
                    THEN CLD.C_UNIT 
                    ELSE CLD.INV_AMT_FC 
                END, 0
            ), 0
        ), 0
    ) AS URETURN_FC_DIVID,
    MAX_LOAN_PCNT,
    CASE
        WHEN PR.PFCAT_CODE IN ('TFUND', 'TETF', 'TSTK') 
            THEN PC.PRICE * PC.UNIT * 
                (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
        WHEN PR.PFCAT_CODE IN ('TSPF', 'TSPD', 'TFB') 
            THEN (PC.PRICE / 100) * PC.UNIT * 
                (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
        WHEN NULLIF(PC.UNIT, 0) IS NULL 
            THEN PC.MKT_AMT_FC - COALESCE(CLD.MKT_AMT_FC, 0)
        WHEN PR.PFCAT_CODE IN ('SFB','FFB','SSPF','FSTD','ODB') 
            THEN PC.PRICE / 100 * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
        ELSE PC.PRICE * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
    END AS MKT_AMT_FC,
    FR.FX_RATE,
    PC.LOAN_PRDTYPE_CODE,
    PR.LOAN_PRDTYPE_NAME,
    PC.CASE_NO,
    PC.PRO_CUR_CODE,
    BASE_DATE,
    ADJ_MAX_LOAN_PCNT,
    ADJ_STD_DATE,
    ADJ_END_DATE,
    (
        CASE
            WHEN PR.PFCAT_CODE IN ('TFUND', 'TETF', 'TSTK') 
                THEN PC.PRICE * PC.UNIT * 
                    (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
            WHEN PR.PFCAT_CODE IN ('TSPF', 'TSPD', 'TFB') 
                THEN (PC.PRICE / 100) * PC.UNIT * 
                    (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
            WHEN NULLIF(PC.UNIT, 0) IS NULL 
                THEN PC.MKT_AMT_FC - COALESCE(CLD.MKT_AMT_FC, 0)
            WHEN PR.PFCAT_CODE IN ('SFB','FFB','SSPF','FSTD','ODB') 
                THEN PC.PRICE / 100 * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
            ELSE PC.PRICE * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
        END
    ) * PC.MAX_LOAN_PCNT / 100 AS MAX_AMT_FC,
    (
        CASE
            WHEN PR.PFCAT_CODE IN ('TFUND', 'TETF', 'TSTK') 
                THEN PC.PRICE * PC.UNIT * 
                    (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
            WHEN PR.PFCAT_CODE IN ('TSPF', 'TSPD', 'TFB') 
                THEN (PC.PRICE / 100) * PC.UNIT * 
                    (CASE WHEN PC.TRAN_CUR_CODE = PC.PRO_CUR_CODE THEN 1.0 ELSE FR2.FX_RATE END)
            WHEN NULLIF(PC.UNIT, 0) IS NULL 
                THEN PC.MKT_AMT_FC - COALESCE(CLD.MKT_AMT_FC, 0)
            WHEN PR.PFCAT_CODE IN ('SFB','FFB','SSPF','FSTD','ODB') 
                THEN PC.PRICE / 100 * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
            ELSE PC.PRICE * (PC.UNIT - COALESCE(CASE WHEN CLD.D_UNIT > 0 THEN CLD.C_UNIT ELSE 0 END, 0))
        END
    ) * PC.ADJ_MAX_LOAN_PCNT / 100 AS ADJ_COLLATERAL_AMT_FC,
    PC.COLLATERAL_YN,
    PR.LOAN_PLATFORM_CODE
FROM CUS_LOAN_PLUS_COLLATERAL PC
LEFT JOIN CUSTOMERS C ON PC.PROVIER_IDN = C.CUS_CODE
LEFT JOIN DBO.PRO_LATEST_FX_RATES FR ON PC.TRAN_CUR_CODE = FR.CUR_CODE AND FR.BASE_CUR_CODE = 'TWD'
LEFT JOIN DBO.CUS_LOAN_PLUS_PRDTYPES PR ON PC.LOAN_PRDTYPE_CODE = PR.LOAN_PRDTYPE_CODE
LEFT JOIN (
    SELECT 
        CLC.CASE_NO,
        CLC.BANK_PRO_CODE,
        CLC.PROVIER_IDN,
        CLC.LOAN_PRDTYPE_CODE,
        REF_NO,
        TRAN_CUR_CODE,
        SUM(CLC.UNIT) AS C_UNIT,
        SUM(CLD.UNIT) AS D_UNIT,
        SUM(CLC.INV_AMT_FC) AS INV_AMT_FC,
        SUM(CLD.TRAN_AMT_FC) AS MKT_AMT_FC
    FROM CUS_LOAN_PLUS_CONTROL CLC
    JOIN CUS_LOAN_PLUS_DECONTROL_DETAIL CLD 
        ON CLC.LOAN_TXN_NO = CLD.CASE_NO + '_' + CONVERT(VARCHAR, CLD.ID) + '_' + CLD.EVENT_ID
    WHERE CLC.LOAN_TRAN_TYPE = '30'
    GROUP BY 
        CLC.CASE_NO,
        CLC.BANK_PRO_CODE,
        CLC.PROVIER_IDN,
        CLC.LOAN_PRDTYPE_CODE,
        REF_NO,
        TRAN_CUR_CODE
) CLD ON 
    CLD.CASE_NO = PC.CASE_NO
    AND CLD.PROVIER_IDN = PC.PROVIER_IDN
    AND CLD.LOAN_PRDTYPE_CODE = PC.LOAN_PRDTYPE_CODE
    AND CLD.BANK_PRO_CODE = PC.BANK_PRO_CODE
    AND COALESCE(CLD.REF_NO, '') = COALESCE(PC.REF_NO, '')
    AND CLD.TRAN_CUR_CODE = PC.TRAN_CUR_CODE
LEFT JOIN DBO.PRO_LATEST_FX_RATES FR2 ON PC.TRAN_CUR_CODE = FR2.BASE_CUR_CODE AND FR2.CUR_CODE = PC.PRO_CUR_CODE
WHERE PC.CASE_NO = '202504290001';
